<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>The P-Median Problem &#8212; spopt v0.6.1 Manual</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css?v=9afac83c" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/pysal-styles.css?v=e5dd7357" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <script src="../_static/documentation_options.js?v=2bd037f0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"TeX": {"equationNumbers": {"autoNumber": "AMS", "useLabelIds": true}}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="../_static/pysal_favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Comparing P-Median Variations" href="p-median_variations.html" />
    <link rel="prev" title="P-Center Problem" href="p-center.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          spopt</a>
        <span class="navbar-text navbar-version pull-left"><b>0.6.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../installation.html">Installation</a></li>
                <li><a href="../tutorials.html">Tutorials</a></li>
                <li><a href="../api.html">API</a></li>
                <li><a href="../references.html">References</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#installing-released-version">Installing released version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#installing-development-version">Installing development version</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="maxp.html">Max-P Regionalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="azp.html">Automatic Zoning Procedure (AZP) algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="skater.html">SKATER</a></li>
<li class="toctree-l2"><a class="reference internal" href="ward.html">Ward</a></li>
<li class="toctree-l2"><a class="reference internal" href="reg-k-means.html">Regional-k-means</a></li>
<li class="toctree-l2"><a class="reference internal" href="randomregion.html">Random Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="component_policy.html">Max-P Regionalization for Multiple Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="lscp.html">The Location Set Covering Problem (LSCP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="lscp_gis.html">Siting First Aid Stations with LSCP on Toronto’s University Campus</a></li>
<li class="toctree-l2"><a class="reference internal" href="lscp_capacity.html">Capacitated Location Set Covering Problem–System Optimal (CLSCP-SO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="lscpb.html">The Backup Coverage Location Problem (LSCP-B)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mclp.html">The Maximal Coverage Location Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="mclp_gis.html">Siting Restaurants with MCLP in San Francisco</a></li>
<li class="toctree-l2"><a class="reference internal" href="p-center.html">P-Center Problem</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">The P-Median Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="p-median_variations.html">Comparing P-Median Variations</a></li>
<li class="toctree-l2"><a class="reference internal" href="p-dispersion.html">The P-Dispersion (max-min-min) Problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="facloc-real-world.html">Empirical examples of facility location problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="facloc-lscpb-real-world.html">Backup Coverage Location Problem: An Empirical Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="facloc-disperse-real-world.html">The P-Dispersion Problem: An Empirical Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api.html#region-methods">Region Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#locate-methods">Locate Methods</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">The P-Median Problem</a><ul>
<li><a class="reference internal" href="#Lattice-10x10">Lattice 10x10</a></li>
<li><a class="reference internal" href="#Simulate-points-in-a-network">Simulate points in a network</a></li>
<li><a class="reference internal" href="#Assign-simulated-points-network-locations">Assign simulated points network locations</a></li>
<li><a class="reference internal" href="#Calculating-the-(network-distance)-cost-matrix">Calculating the (network distance) cost matrix</a></li>
<li><a class="reference internal" href="#Calculating-euclidean-distance-from-a-GeoDataFrame">Calculating euclidean distance from a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code></a></li>
<li><a class="reference internal" href="#Plotting-the-results">Plotting the results</a><ul>
<li><a class="reference internal" href="#P-Median-built-from-cost-matrix-(network-distance)">P-Median built from cost matrix (network distance)</a></li>
<li><a class="reference internal" href="#P-median-built-from-geodataframes-(euclidean-distance)">P-median built from geodataframes (euclidean distance)</a></li>
<li><a class="reference internal" href="#P-median-with-preselected-facilities-(euclidean-distance)">P-median with preselected facilities (euclidean distance)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Comparing-solution-from-varied-metrics">Comparing solution from varied metrics</a></li>
<li><a class="reference internal" href="#Capacitated-p-median-problem">Capacitated p-median problem</a><ul>
<li><a class="reference internal" href="#Capacitated-p-median-problem-with-preselected-facilities">Capacitated p-median problem with preselected facilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="admonition note">
<p>This page was generated from <a class="reference external" href="https://github.com/pysal/spopt/blob/main/notebooks/p-median.ipynb">notebooks/p-median.ipynb</a>.
Interactive online version:
<span class="raw-html"><a href="https://mybinder.org/v2/gh/pysal/spopt/main?filepath=notebooks/p-median.ipynb"><img alt="Binder badge" src="https://mybinder.org/badge_logo.svg" style="vertical-align:text-bottom"></a></span></p>
</div>
<section id="The-P-Median-Problem">
<h1>The P-Median Problem<a class="headerlink" href="#The-P-Median-Problem" title="Link to this heading">¶</a></h1>
<p><em>Authors:</em> <a class="reference external" href="https://github.com/gegen07">Germano Barcelos</a>, <a class="reference external" href="https://github.com/jGaboardi">James Gaboardi</a>, <a class="reference external" href="https://github.com/ljwolf">Levi J. Wolf</a>, <a class="reference external" href="https://github.com/qszhao">Qunshan Zhao</a></p>
<p>Hakimi (1965) proposed this model thinking about locating telephone switching centers. The objective was to minimize the total length of wire serving all customers while locating <span class="math notranslate nohighlight">\(p\)</span> telephone switching centers, assuming that each customer would be connected to the closest switching center. Here the objective is to <em>locate a fixed number of facilities such that the resulting sum of travel distances is minimized</em>.</p>
<p><strong>P-Median can be written as:</strong></p>
<p>:math:<a href="#id2"><span class="problematic" id="id3">`</span></a>begin{array} displaystyle textbf{Minimize} &amp; displaystyle sum_{i in I}sum_{j in J}{a_i d_{ij} X_{ij}} &amp;&amp;&amp; (1) \
displaystyle textbf{Subject to:} &amp; displaystyle sum_{j in J}{X_{ij} = 1} &amp; forall i in I &amp;&amp; (2) \</p>
<blockquote>
<div><p>&amp; displaystyle sum_{j in J}{Y_{j} = p} &amp;&amp;&amp; (3) \
&amp; X_{ij} leq Y_{j} &amp; forall i in I &amp; forall j in J &amp; (4) \
&amp; X_{ij} in {0,1} &amp; forall i in I &amp; forall j in J &amp; (5) \
&amp; Y_{j} in {0,1} &amp; forall j in J &amp;&amp; (6) \ end{array}`</p>
</div></blockquote>
<p>:math:<a href="#id4"><span class="problematic" id="id5">`</span></a>begin{array} displaystyle textbf{Where:}\ &amp; &amp; displaystyle i &amp; small = &amp; textrm{index referencing nodes of the network as demand} \
&amp; &amp; j &amp; small = &amp; textrm{index referencing nodes of the network as potential facility sites} \
&amp; &amp; d_{ij} &amp; small = &amp; textrm{shortest distance or travel time between nodes } i textrm{ and } j \
&amp; &amp; p &amp; small = &amp; textrm{number of facilities to be located} \
&amp; &amp; a_i &amp; small = &amp; textrm{service load or population demand at } i \
&amp; &amp; X_{ij} &amp; small = &amp; begin{cases}</p>
<blockquote>
<div><blockquote>
<div><p>1, textrm{if demand } i textrm{ is assigned to facility } j \
0, textrm{otherwise}</p>
</div></blockquote>
<p>end{cases} \</p>
</div></blockquote>
<dl>
<dt>&amp; &amp; Y_{j} &amp; small = &amp; begin{cases}</dt><dd><blockquote>
<div><p>1, textrm{if node } j textrm{ has been selected for a facility} \
0, textrm{otherwise} \</p>
</div></blockquote>
<p>end{cases} \</p>
</dd>
</dl>
<p>end{array}`</p>
<p><em>The formulation above is adapted from Church and Murray (2018)</em></p>
<p>This tutorial generates synthetic demand (clients) and facility sites near a 10x10 lattice representing a gridded urban core.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PMedian.from_cost_matrix()</span></code> with network distance as the metric</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PMedian.from_geodataframe()</span></code> with euclidean distance as the metric</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PMedian.from_geodataframe()</span></code> with predefined facility locations and euclidean distance as the metric</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%config InlineBackend.figure_format = &quot;retina&quot;
%load_ext watermark
%watermark
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Last updated: 2023-12-10T14:04:33.200767-05:00

Python implementation: CPython
Python version       : 3.12.0
IPython version      : 8.18.0

Compiler    : Clang 15.0.7
OS          : Darwin
Release     : 23.1.0
Machine     : x86_64
Processor   : i386
CPU cores   : 8
Architecture: 64bit

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import geopandas
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
import matplotlib.lines as mlines
import numpy
import pulp
import shapely
import spopt
from spopt.locate import PMedian, simulated_geo_points

import warnings
with warnings.catch_warnings():
    warnings.simplefilter(&quot;ignore&quot;)
    # ignore deprecation warning - GH pysal/spaghetti#649
    import spaghetti

%watermark -w
%watermark -iv
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Watermark: 2.4.3

matplotlib: 3.8.2
shapely   : 2.0.2
pulp      : 2.7.0
spaghetti : 1.7.4
spopt     : 0.5.1.dev53+g5cadae7
numpy     : 1.26.2
geopandas : 0.14.1

</pre></div></div>
</div>
<p>Since the model needs a cost matrix (distance, time, etc.) we should define some variables. First we will assign some the number of clients and facility locations, then the maximum service radius, followed by random seeds in order to reproduce the results. Finally, the solver, assigned below as <code class="docutils literal notranslate"><span class="pre">pulp.COIN_CMD</span></code>, is an interface to optimization solver developed by <a class="reference external" href="https://github.com/coin-or/Cbc">COIN-OR</a>. If you want to use another optimization interface, such as Gurobi or CPLEX, see this
<a class="reference external" href="https://coin-or.github.io/pulp/guides/how_to_configure_solvers.html">guide</a> that explains how to achieve this.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># quantity demand points
CLIENT_COUNT = 100

# quantity supply points
FACILITY_COUNT = 10

# number of candidate facilities in optimal solution
P_FACILITIES = 3

# random seeds for reproducibility
CLIENT_SEED = 5
FACILITY_SEED = 6

# set the solver
solver = pulp.COIN_CMD(msg=False, warmStart=True)
</pre></div>
</div>
</div>
<section id="Lattice-10x10">
<h2>Lattice 10x10<a class="headerlink" href="#Lattice-10x10" title="Link to this heading">¶</a></h2>
<p>Create a 10x10 lattice with 9 interior lines, both vertical and horizontal.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>with warnings.catch_warnings():
    warnings.simplefilter(&quot;ignore&quot;)
    # ignore deprecation warning - GH pysal/libpysal#468
    lattice = spaghetti.regular_lattice((0, 0, 10, 10), 9, exterior=True)
ntw = spaghetti.Network(in_data=lattice)
</pre></div>
</div>
</div>
<p>Transform the <code class="docutils literal notranslate"><span class="pre">spaghetti</span></code> instance into a geodataframe.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>streets = spaghetti.element_as_gdf(ntw, arcs=True)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>streets_buffered = geopandas.GeoDataFrame(
    geopandas.GeoSeries(streets[&quot;geometry&quot;].buffer(0.5).unary_union),
    crs=streets.crs,
    columns=[&quot;geometry&quot;],
)
</pre></div>
</div>
</div>
<p>Plotting the network created by <code class="docutils literal notranslate"><span class="pre">spaghetti</span></code> we can verify that it mimics a district with quarters and streets.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>streets.plot();
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_p-median_11_0.png" class="no-scaled-link" src="../_images/notebooks_p-median_11_0.png" style="width: 416px; height: 413px;" />
</div>
</div>
</section>
<section id="Simulate-points-in-a-network">
<h2>Simulate points in a network<a class="headerlink" href="#Simulate-points-in-a-network" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">simulated_geo_points</span></code> function simulates points near a network. In this case, it uses the 10x10 lattice network created using the <code class="docutils literal notranslate"><span class="pre">spaghetti</span></code> package. Below we use the function defined above and simulate the points near the lattice edges.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>client_points = simulated_geo_points(
    streets_buffered, needed=CLIENT_COUNT, seed=CLIENT_SEED
)
facility_points = simulated_geo_points(
    streets_buffered, needed=FACILITY_COUNT, seed=FACILITY_SEED
)
</pre></div>
</div>
</div>
<p>Plotting the 100 client and 10 facility points we can see that the function generates dummy points to an area of 10x10, which is the area created by our lattice created on previous cells.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(figsize=(6, 6))
streets.plot(ax=ax, alpha=0.8, zorder=1, label=&quot;streets&quot;)
facility_points.plot(
    ax=ax, color=&quot;red&quot;, zorder=2, label=f&quot;facility candidate sites ($n$={FACILITY_COUNT})&quot;
)
client_points.plot(ax=ax, color=&quot;black&quot;, label=f&quot;clients sites ($n$={CLIENT_COUNT})&quot;)
plt.legend(loc=&quot;upper left&quot;, bbox_to_anchor=(1.05, 1));
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_p-median_15_0.png" class="no-scaled-link" src="../_images/notebooks_p-median_15_0.png" style="width: 802px; height: 501px;" />
</div>
</div>
<p>For each client point the model supposes that there is a weight. So, we assign some random integers using <code class="docutils literal notranslate"><span class="pre">numpy</span></code> to simulate these weights. We will simulate weights in a range from a minimum of 1 and a maximum of 12.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>numpy.random.seed(0)
ai = numpy.random.randint(1, 12, CLIENT_COUNT)
ai
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 6,  1,  4,  4,  8, 10,  4,  6,  3,  5,  8,  7,  9,  9, 11,  2,  7,
        8,  8,  9,  2,  6, 10,  9, 10,  5,  4,  1,  4,  6,  1,  3,  4,  9,
        2,  4,  4,  4,  8,  1,  2, 10, 10,  1, 11,  5,  8,  4,  3,  8,  3,
        1,  1,  5,  6,  6,  7,  9,  5,  2,  5, 10, 11, 11,  9,  2,  2,  8,
       10, 10,  4,  7,  8,  3,  1,  4,  6, 10, 11,  5,  5,  7,  5,  5,  4,
        5,  5,  9,  5,  4, 11,  8,  6,  6,  1,  2,  6, 10,  4,  1])
</pre></div></div>
</div>
<p>What’s total the value of “weighted” clients?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>client_points[&quot;weights&quot;] = ai
client_points[&quot;weights&quot;].sum()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
579
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(figsize=(6, 6))
streets.plot(ax=ax, alpha=0.8, zorder=1, label=&quot;streets&quot;)
client_points.plot(
    ax=ax,
    color=&quot;black&quot;,
    label=f&quot;clients sized weight\n\t$\\sum$={client_points[&#39;weights&#39;].sum()}&quot;,
    markersize=ai*2
)
plt.legend(loc=&quot;upper left&quot;, bbox_to_anchor=(1.05, 1));
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_p-median_20_0.png" class="no-scaled-link" src="../_images/notebooks_p-median_20_0.png" style="width: 729px; height: 501px;" />
</div>
</div>
</section>
<section id="Assign-simulated-points-network-locations">
<h2>Assign simulated points network locations<a class="headerlink" href="#Assign-simulated-points-network-locations" title="Link to this heading">¶</a></h2>
<p>The simulated client and facility points do not adhere to network space. Calculating distances between them without restricting movement to the network results in a euclidean distances,’as the crow flies.’ While this is acceptable for some applications, for others it is more realistic to consider network traversal (e.g. Does a mail carrier follow roads to deliver letters or fly from mailbox to mailbox?).</p>
<p>In our first example we will consider distance along the 10x10 lattice network created above. Therefore, we must first snap the observation points to the network prior to calculating a cost matrix.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>with warnings.catch_warnings():
    warnings.simplefilter(&quot;ignore&quot;)
    # ignore deprecation warning - GH pysal/libpysal#468
    ntw.snapobservations(client_points, &quot;clients&quot;, attribute=True)
clients_snapped = spaghetti.element_as_gdf(ntw, pp_name=&quot;clients&quot;, snapped=True)
clients_snapped.drop(columns=[&quot;id&quot;, &quot;comp_label&quot;], inplace=True)

with warnings.catch_warnings():
    warnings.simplefilter(&quot;ignore&quot;)
    # ignore deprecation warning - GH pysal/libpysal#468
    ntw.snapobservations(facility_points, &quot;facilities&quot;, attribute=True)
facilities_snapped = spaghetti.element_as_gdf(ntw, pp_name=&quot;facilities&quot;, snapped=True)
facilities_snapped.drop(columns=[&quot;id&quot;, &quot;comp_label&quot;], inplace=True)
</pre></div>
</div>
</div>
<p>Now the plot seems more organized as the points occupy network space. The network is plotted below with the network locations of the facility points and clients points.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, ax = plt.subplots(figsize=(6, 6))
streets.plot(ax=ax, alpha=0.8, zorder=1, label=&quot;streets&quot;)
facilities_snapped.plot(
    ax=ax, color=&quot;red&quot;, zorder=2, label=f&quot;facility candidate sites ($n$={FACILITY_COUNT})&quot;
)
clients_snapped.plot(ax=ax, color=&quot;black&quot;, label=f&quot;clients sites ($n$={CLIENT_COUNT})&quot;)
plt.legend(loc=&quot;upper left&quot;, bbox_to_anchor=(1.05, 1));
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_p-median_24_0.png" class="no-scaled-link" src="../_images/notebooks_p-median_24_0.png" style="width: 798px; height: 505px;" />
</div>
</div>
</section>
<section id="Calculating-the-(network-distance)-cost-matrix">
<h2>Calculating the (network distance) cost matrix<a class="headerlink" href="#Calculating-the-(network-distance)-cost-matrix" title="Link to this heading">¶</a></h2>
<p>Calculate the network distance between clients and facilities.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cost_matrix = ntw.allneighbordistances(
    sourcepattern=ntw.pointpatterns[&quot;clients&quot;],
    destpattern=ntw.pointpatterns[&quot;facilities&quot;],
)
cost_matrix.shape
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(100, 10)
</pre></div></div>
</div>
<p>The expected result here is a network distance between clients and facilities points, in our case a 2D 100x10 array.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cost_matrix[:5,:]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[13.39951703, 15.61157572,  4.39383189,  8.40604635,  3.73034161,
         3.4833522 ,  6.2764559 ,  5.52085069, 11.59649553,  7.51670161],
       [13.92618165, 16.13824034,  4.92049651,  8.93271097,  4.25700623,
         4.01001682,  6.80312052,  4.99418607, 12.12316015,  8.04336623],
       [ 7.55064416,  9.76270285,  4.54495901,  2.55717348,  2.57689625,
         2.36552068,  0.42758302,  5.36972356,  5.74762266,  6.33217127],
       [ 3.52405953,  5.73611822,  8.11317865,  3.87460688,  6.14511589,
         6.3921053 ,  3.5990016 ,  6.19849608,  1.72103803,  4.35875589],
       [ 7.75652815,  7.09845387,  6.75084301,  4.76305747,  4.78278024,
         7.02976965,  6.63346702, 12.03397254,  7.95350665, 12.99642024]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cost_matrix[-5:,:]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[ 4.82677859,  7.03883728,  6.8104596 ,  4.16669209,  4.84239683,
         5.08938625,  2.29628254,  4.89577702,  3.02375709,  4.06667068],
       [ 6.47650911,  8.6885678 ,  5.47082397,  2.82705646,  3.5027612 ,
         3.43965572,  0.95664692,  4.44385861,  4.67348761,  5.40630631],
       [10.9188216 , 13.13088029,  4.71841659,  5.92535092,  2.05492631,
         1.00265676,  3.79576046,  5.19626599,  9.1158001 ,  6.15871369],
       [ 3.17082521,  5.3828839 ,  8.46641298,  1.82264547,  6.49835021,
         6.74533963,  3.95223592,  7.74954251,  3.36780371,  8.4107173 ],
       [10.03753584,  6.81744618,  7.0318507 ,  7.04406516,  7.06378793,
         9.31077734,  8.91447471, 14.31498023, 10.23451434, 15.27742793]])
</pre></div></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">PMedian.from_cost_matrix</span></code> we model the <span class="math notranslate nohighlight">\(p\)</span>-median problem to minimize the total <em>weighted</em> cost between clients and <span class="math notranslate nohighlight">\(p\)</span> facilities, 3 in our case, while ensuring that each client is assigned to one, and only one, facility. We use the network distance matrix calculated above (in generic ‘distance units’) to model cost.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmedian_from_cm = PMedian.from_cost_matrix(
    cost_matrix,
    ai,
    p_facilities=P_FACILITIES,
    name=&quot;p-median-network-distance&quot;
)
</pre></div>
</div>
</div>
<p>The expected result is a solved instance of <code class="docutils literal notranslate"><span class="pre">PMedian</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmedian_from_cm = pmedian_from_cm.solve(solver)
pmedian_from_cm
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;spopt.locate.p_median.PMedian at 0x163c9b650&gt;
</pre></div></div>
</div>
<p>What’s total and mean minimized weighted cost?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmp_obj = round(pmedian_from_cm.problem.objective.value(), 3)
pmp_mean = round(pmedian_from_cm.mean_dist, 3)
print(
    f&quot;A total minimized weighted distance of {pmp_obj} units is &quot;
    f&quot;observed, with a mean distance of {pmp_mean} per individual client.&quot;
)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
A total minimized weighted distance of 2117.596 units is observed, with a mean distance of 3.657 per individual client.
</pre></div></div>
</div>
<p>Define the decision variable names used for mapping later.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>facility_points[&quot;dv&quot;] = pmedian_from_cm.fac_vars
facility_points[&quot;dv&quot;] = facility_points[&quot;dv&quot;].map(lambda x: x.name.replace(&quot;_&quot;, &quot;&quot;))
facilities_snapped[&quot;dv&quot;] = facility_points[&quot;dv&quot;]
facility_points
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>dv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POINT (9.32146 3.15178)</td>
      <td>y0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POINT (8.53352 -0.04134)</td>
      <td>y1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POINT (0.68422 6.04557)</td>
      <td>y2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POINT (5.32799 4.10688)</td>
      <td>y3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POINT (3.18949 6.34771)</td>
      <td>y4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>POINT (4.31956 7.59470)</td>
      <td>y5</td>
    </tr>
    <tr>
      <th>6</th>
      <td>POINT (5.19840 5.86744)</td>
      <td>y6</td>
    </tr>
    <tr>
      <th>7</th>
      <td>POINT (6.59891 10.39247)</td>
      <td>y7</td>
    </tr>
    <tr>
      <th>8</th>
      <td>POINT (8.51844 4.04521)</td>
      <td>y8</td>
    </tr>
    <tr>
      <th>9</th>
      <td>POINT (9.13894 8.56135)</td>
      <td>y9</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Calculating-euclidean-distance-from-a-GeoDataFrame">
<h2>Calculating euclidean distance from a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code><a class="headerlink" href="#Calculating-euclidean-distance-from-a-GeoDataFrame" title="Link to this heading">¶</a></h2>
<p>With <code class="docutils literal notranslate"><span class="pre">PMedian.from_cost_matrix</span></code> we model the <span class="math notranslate nohighlight">\(p\)</span>-median problem to minimize the total <em>weighted</em> cost between clients and <span class="math notranslate nohighlight">\(p\)</span> facilities, 3 in our case, while ensuring that each client is assigned to one, and only one, facility. Here we use geodataframes to calculate a euclidean distance cost matrix.</p>
<p>Next we will solve the <span class="math notranslate nohighlight">\(p\)</span>-median problem considering all 10 candidate locations for potential selection.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>distance_metric = &quot;euclidean&quot;
clients_snapped[&quot;weights&quot;] = client_points[&quot;weights&quot;]
pmedian_from_gdf = PMedian.from_geodataframe(
    clients_snapped,
    facilities_snapped,
    &quot;geometry&quot;,
    &quot;geometry&quot;,
    &quot;weights&quot;,
    p_facilities=P_FACILITIES,
    distance_metric=distance_metric,
    name=f&quot;p-median-{distance_metric}-distance&quot;
)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmedian_from_gdf = pmedian_from_gdf.solve(solver)
pmp_obj = round(pmedian_from_gdf.problem.objective.value(), 3)
pmp_mean = round(pmedian_from_gdf.mean_dist, 3)
print(
    f&quot;A total minimized weighted distance of {pmp_obj} units is &quot;
    f&quot;observed, with a mean distance of {pmp_mean} per individual client.&quot;
)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
A total minimized weighted distance of 1642.918 units is observed, with a mean distance of 2.838 per individual client.
</pre></div></div>
</div>
<p>However, in many real world applications there may already be existing facility locations with the goal being to add one or more new facilities. Here we will define facilites <span class="math notranslate nohighlight">\(y_0\)</span> and <span class="math notranslate nohighlight">\(y_1\)</span> as already existing (they must be present in the model solution). This will lead to a sub-optimal solution.</p>
<p><strong>Important:</strong> The facilities in <code class="docutils literal notranslate"><span class="pre">&quot;predefined_loc&quot;</span></code> are a binary array where <code class="docutils literal notranslate"><span class="pre">1</span></code> means the associated location must appear in the solution.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>facility_points[&quot;predefined_loc&quot;] = 0
facility_points.loc[(0, 1), &quot;predefined_loc&quot;] = 1
facilities_snapped[&quot;predefined_loc&quot;] = facility_points[&quot;predefined_loc&quot;]
facility_points
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>dv</th>
      <th>predefined_loc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POINT (9.32146 3.15178)</td>
      <td>y0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POINT (8.53352 -0.04134)</td>
      <td>y1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POINT (0.68422 6.04557)</td>
      <td>y2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POINT (5.32799 4.10688)</td>
      <td>y3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POINT (3.18949 6.34771)</td>
      <td>y4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>POINT (4.31956 7.59470)</td>
      <td>y5</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>POINT (5.19840 5.86744)</td>
      <td>y6</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>POINT (6.59891 10.39247)</td>
      <td>y7</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>POINT (8.51844 4.04521)</td>
      <td>y8</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>POINT (9.13894 8.56135)</td>
      <td>y9</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmedian_from_gdf_pre = PMedian.from_geodataframe(
    clients_snapped,
    facilities_snapped,
    &quot;geometry&quot;,
    &quot;geometry&quot;,
    &quot;weights&quot;,
    p_facilities=P_FACILITIES,
    predefined_facility_col=&quot;predefined_loc&quot;,
    distance_metric=distance_metric,
    name=f&quot;p-median-{distance_metric}-distance-predefined&quot;
)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmedian_from_gdf_pre = pmedian_from_gdf_pre.solve(solver)
pmp_obj = round(pmedian_from_gdf_pre.problem.objective.value(), 3)
pmp_mean = round(pmedian_from_gdf_pre.mean_dist, 3)
print(
    f&quot;A total minimized weighted distance of {pmp_obj} units is &quot;
    f&quot;observed, with a mean distance of {pmp_mean} per individual client.&quot;
)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
A total minimized weighted distance of 2080.805 units is observed, with a mean distance of 3.594 per individual client.
</pre></div></div>
</div>
</section>
<section id="Plotting-the-results">
<h2>Plotting the results<a class="headerlink" href="#Plotting-the-results" title="Link to this heading">¶</a></h2>
<p>The two cells below describe the plotting of the results. For each method from the <code class="docutils literal notranslate"><span class="pre">PMedian</span></code> class (<code class="docutils literal notranslate"><span class="pre">.from_cost_matrix()</span></code>, <code class="docutils literal notranslate"><span class="pre">.from_geodataframe()</span></code>) there is a plot displaying the facility site that was selected with a star colored and the points covered with the same color.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dv_colors_arr = [
    &quot;darkcyan&quot;,
    &quot;mediumseagreen&quot;,
    &quot;saddlebrown&quot;,
    &quot;darkslategray&quot;,
    &quot;lightskyblue&quot;,
    &quot;thistle&quot;,
    &quot;lavender&quot;,
    &quot;darkgoldenrod&quot;,
    &quot;peachpuff&quot;,
    &quot;coral&quot;,
    &quot;mediumvioletred&quot;,
    &quot;blueviolet&quot;,
    &quot;fuchsia&quot;,
    &quot;cyan&quot;,
    &quot;limegreen&quot;,
    &quot;mediumorchid&quot;,
]
dv_colors = {f&quot;y{i}&quot;: dv_colors_arr[i] for i in range(len(dv_colors_arr))}
dv_colors
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;y0&#39;: &#39;darkcyan&#39;,
 &#39;y1&#39;: &#39;mediumseagreen&#39;,
 &#39;y2&#39;: &#39;saddlebrown&#39;,
 &#39;y3&#39;: &#39;darkslategray&#39;,
 &#39;y4&#39;: &#39;lightskyblue&#39;,
 &#39;y5&#39;: &#39;thistle&#39;,
 &#39;y6&#39;: &#39;lavender&#39;,
 &#39;y7&#39;: &#39;darkgoldenrod&#39;,
 &#39;y8&#39;: &#39;peachpuff&#39;,
 &#39;y9&#39;: &#39;coral&#39;,
 &#39;y10&#39;: &#39;mediumvioletred&#39;,
 &#39;y11&#39;: &#39;blueviolet&#39;,
 &#39;y12&#39;: &#39;fuchsia&#39;,
 &#39;y13&#39;: &#39;cyan&#39;,
 &#39;y14&#39;: &#39;limegreen&#39;,
 &#39;y15&#39;: &#39;mediumorchid&#39;}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_results(model, p, facs, clis=None, ax=None):
    &quot;&quot;&quot;Visualize optimal solution sets and context.&quot;&quot;&quot;
    if not ax:
        multi_plot = False
        fig, ax = plt.subplots(figsize=(6, 6))
        markersize, markersize_factor = 4, 4
    else:
        ax.axis(&quot;off&quot;)
        multi_plot = True
        markersize, markersize_factor = 2, 2
    ax.set_title(model.name, fontsize=15)

    # extract facility-client relationships for plotting (except for p-dispersion)
    plot_clis = isinstance(clis, geopandas.GeoDataFrame)
    if plot_clis:
        cli_points = {}
    fac_sites = {}
    for i, dv in enumerate(model.fac_vars):
        if dv.varValue:
            dv, predef = facs.loc[i, [&quot;dv&quot;, &quot;predefined_loc&quot;]]
            fac_sites[dv] = [i, predef]
            if plot_clis:
                geom = clis.iloc[model.fac2cli[i]][&quot;geometry&quot;]
                cli_points[dv] = geom

    # study area and legend entries initialization
    streets.plot(ax=ax, alpha=1, color=&quot;black&quot;, zorder=1)
    legend_elements = [mlines.Line2D([], [], color=&quot;black&quot;, label=&quot;streets&quot;)]

    if plot_clis:
        # any clients that not asscociated with a facility
        if model.name.startswith(&quot;mclp&quot;):
            c = &quot;k&quot;
            if model.n_cli_uncov:
                idx = [i for i, v in enumerate(model.cli2fac) if len(v) == 0]
                pnt_kws = dict(ax=ax, fc=c, ec=c, marker=&quot;s&quot;, markersize=7, zorder=2)
                clis.iloc[idx].plot(**pnt_kws)
            _label = f&quot;Demand sites not covered ($n$={model.n_cli_uncov})&quot;
            _mkws = dict(marker=&quot;s&quot;, markerfacecolor=c, markeredgecolor=c, linewidth=0)
            legend_elements.append(mlines.Line2D([], [], ms=3, label=_label, **_mkws))

    # all candidate facilities
    facs.plot(ax=ax, fc=&quot;brown&quot;, marker=&quot;*&quot;, markersize=80, zorder=8)
    _label = f&quot;Facility sites ($n$={len(model.fac_vars)})&quot;
    _mkws = dict(marker=&quot;*&quot;, markerfacecolor=&quot;brown&quot;, markeredgecolor=&quot;brown&quot;)
    legend_elements.append(mlines.Line2D([], [], ms=7, lw=0, label=_label, **_mkws))

    # facility-(client) symbology and legend entries
    zorder = 4
    for fname, (fac, predef) in fac_sites.items():
        cset = dv_colors[fname]
        if plot_clis:
            # clients
            geoms = cli_points[fname]
            gdf = geopandas.GeoDataFrame(geoms)
            gdf.plot(ax=ax, zorder=zorder, ec=&quot;k&quot;, fc=cset, markersize=100 * markersize)
            _label = f&quot;Demand sites covered by {fname}&quot;
            _mkws = dict(markerfacecolor=cset, markeredgecolor=&quot;k&quot;, ms=markersize + 7)
            legend_elements.append(
                mlines.Line2D([], [], marker=&quot;o&quot;, lw=0, label=_label, **_mkws)
            )
        # facilities
        ec = &quot;k&quot;
        lw = 2
        predef_label = &quot;predefined&quot;
        if model.name.endswith(predef_label) and predef:
            ec = &quot;r&quot;
            lw = 3
            fname += f&quot; ({predef_label})&quot;
        facs.iloc[[fac]].plot(
            ax=ax, marker=&quot;*&quot;, markersize=1000, zorder=9, fc=cset, ec=ec, lw=lw
        )
        _mkws = dict(markerfacecolor=cset, markeredgecolor=ec, markeredgewidth=lw)
        legend_elements.append(
            mlines.Line2D([], [], marker=&quot;*&quot;, ms=20, lw=0, label=fname, **_mkws)
        )
        # increment zorder up and markersize down for stacked client symbology
        zorder += 1
        if plot_clis:
            markersize -= markersize_factor / p

    if not multi_plot:
        # legend
        kws = dict(loc=&quot;upper left&quot;, bbox_to_anchor=(1.05, 0.7))
        plt.legend(handles=legend_elements, **kws)
</pre></div>
</div>
</div>
<section id="P-Median-built-from-cost-matrix-(network-distance)">
<h3>P-Median built from cost matrix (network distance)<a class="headerlink" href="#P-Median-built-from-cost-matrix-(network-distance)" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_results(pmedian_from_cm, P_FACILITIES, facility_points, clis=client_points)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_p-median_49_0.png" class="no-scaled-link" src="../_images/notebooks_p-median_49_0.png" style="width: 791px; height: 525px;" />
</div>
</div>
</section>
<section id="P-median-built-from-geodataframes-(euclidean-distance)">
<h3>P-median built from geodataframes (euclidean distance)<a class="headerlink" href="#P-median-built-from-geodataframes-(euclidean-distance)" title="Link to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_results(pmedian_from_gdf, P_FACILITIES, facility_points, clis=client_points)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_p-median_51_0.png" class="no-scaled-link" src="../_images/notebooks_p-median_51_0.png" style="width: 791px; height: 525px;" />
</div>
</div>
<p>You may notice that the model results are similar, yet different. This is expected as the distances between facility and demand points are calculated with different metrics (network vs. euclidean distance).</p>
</section>
<section id="P-median-with-preselected-facilities-(euclidean-distance)">
<h3>P-median with preselected facilities (euclidean distance)<a class="headerlink" href="#P-median-with-preselected-facilities-(euclidean-distance)" title="Link to this heading">¶</a></h3>
<p>Finally, let’s visualize the results of the <span class="math notranslate nohighlight">\(p\)</span>-median problem when stipulating that facilities <span class="math notranslate nohighlight">\(y_0\)</span> and <span class="math notranslate nohighlight">\(y_1\)</span> must be included in the final selection.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot_results(pmedian_from_gdf_pre, P_FACILITIES, facility_points, clis=client_points)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_p-median_53_0.png" class="no-scaled-link" src="../_images/notebooks_p-median_53_0.png" style="width: 791px; height: 525px;" />
</div>
</div>
<p>Here, the differences is explained by the preselected facilities <span class="math notranslate nohighlight">\(y_0\)</span> and <span class="math notranslate nohighlight">\(y_1\)</span>. So, the <span class="math notranslate nohighlight">\(p\)</span>-median model chooses the facility <span class="math notranslate nohighlight">\(y_4\)</span> to minimize the total weighted cost to serve all clients.</p>
</section>
</section>
<hr class="docutils" />
<section id="Comparing-solution-from-varied-metrics">
<h2>Comparing solution from varied metrics<a class="headerlink" href="#Comparing-solution-from-varied-metrics" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, axarr = plt.subplots(1, 3, figsize=(20, 10))
fig.subplots_adjust(wspace=-0.01)
for i, m in enumerate([pmedian_from_cm, pmedian_from_gdf, pmedian_from_gdf_pre]):
    plot_results(m, P_FACILITIES, facility_points, clis=client_points, ax=axarr[i])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_p-median_55_0.png" class="no-scaled-link" src="../_images/notebooks_p-median_55_0.png" style="width: 1569px; height: 556px;" />
</div>
</div>
</section>
<section id="Capacitated-p-median-problem">
<h2>Capacitated p-median problem<a class="headerlink" href="#Capacitated-p-median-problem" title="Link to this heading">¶</a></h2>
<p>Based on the classic p-median problem, we further consider the location allocation problem with the facility’s capacity, and the amount of demand at the demand point. Therefore, we add new functions to <code class="docutils literal notranslate"><span class="pre">p-median</span></code> function of <code class="docutils literal notranslate"><span class="pre">spopt</span></code>, to solve this type of problem.</p>
<p><strong>Capacitated P-Median can be written as:</strong></p>
<p>:math:<a href="#id6"><span class="problematic" id="id7">`</span></a>begin{array} displaystyle textbf{Minimize} &amp; displaystyle sum_{i in I}sum_{j in J}{a_i d_{ij} X_{ij}} &amp;&amp;&amp; (1) \
displaystyle textbf{Subject to:} &amp; displaystyle sum_{j in J}{X_{ij} = 1} &amp; forall i in I &amp;&amp; (2) \</p>
<blockquote>
<div><p>&amp; displaystyle sum_{j in J}{Y_{j} = p} &amp;&amp;&amp; (3) \
&amp; displaystyle sum_{i in I}{a_i X_{ij} leq {c_j Y_{j}}}&amp; forall j in J &amp;&amp; (4) \
&amp; X_{ij} leq Y_{j} &amp; forall i in I &amp; forall j in J &amp; (5) \
&amp; X_{ij} in {0,1} &amp; forall i in I &amp; forall j in J &amp; (6) \
&amp; Y_{j} in {0,1} &amp; forall j in J &amp;&amp; (7) \ end{array}`</p>
</div></blockquote>
<p>:math:<a href="#id8"><span class="problematic" id="id9">`</span></a>begin{array} displaystyle textbf{Where:}\ &amp; &amp; displaystyle i &amp; small = &amp; textrm{index referencing nodes of the network as demand} \
&amp; &amp; j &amp; small = &amp; textrm{index referencing nodes of the network as potential facility sites} \
&amp; &amp; d_{ij} &amp; small = &amp; textrm{shortest distance or travel time between nodes } i textrm{ and } j \
&amp; &amp; p &amp; small = &amp; textrm{number of facilities to be located} \
&amp; &amp; a_i &amp; small = &amp; textrm{service load or population demand at } i \
&amp; &amp; c_j &amp; small = &amp; textrm{capacity of facility} j \
&amp; &amp; X_{ij} &amp; small = &amp; begin{cases}</p>
<blockquote>
<div><blockquote>
<div><p>1, textrm{if demand } i textrm{ is assigned to facility } j \
0, textrm{otherwise}</p>
</div></blockquote>
<p>end{cases} \</p>
</div></blockquote>
<dl>
<dt>&amp; &amp; Y_{j} &amp; small = &amp; begin{cases}</dt><dd><blockquote>
<div><p>1, textrm{if node } j textrm{ has been selected for a facility} \
0, textrm{otherwise} \</p>
</div></blockquote>
<p>end{cases} \</p>
</dd>
</dl>
<p>end{array}`</p>
<p><em>The formulation above is adapted from Church and Murray (2009)</em></p>
<p>In the previous p-median problem, we have the demand value of each client point, which is the ‘weight’. And in that condition, we acutally assume that the capacity of each facility is infinite. Now we can make this model more realisitic by considering the capacity.</p>
<p>Again, we would take the p-median case with network distance as the example, to introduce how to achieve the capacity constraint by using the <code class="docutils literal notranslate"><span class="pre">facility_capacities</span></code> function.</p>
<p>Firstly, we need to create the facility’s capacity, by assigning some random integers using <code class="docutils literal notranslate"><span class="pre">numpy</span></code> to simulate these values. We will simulate capacity in a range from a minimum of 60 and a maximum of 120.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>numpy.random.seed(1)
cj = numpy.random.randint(60, 120, FACILITY_COUNT)
cj
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 97, 103,  72,  68,  69,  71,  65,  75,  60,  76])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>facility_points[&quot;capacity&quot;] = cj
facility_points[&quot;capacity&quot;].sum()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
756
</pre></div></div>
</div>
<p>The sum of the facility capacity is 756, which is more than the total amount of demand, 579. It means the 10 facilities can accommodate all the demand.</p>
<p>It also means we need to increase the number of candidate facilities in the final optimal solution, because the capacity is limited.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmedian_capacity_from_cm = PMedian.from_cost_matrix(
    cost_matrix,
    ai,
    p_facilities = 8,
    facility_capacities=cj,
    name=&quot;p-median-network-distance&quot;
)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmedian_capacity_from_cm = pmedian_capacity_from_cm.solve(solver)
pmedian_capacity_from_cm
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;spopt.locate.p_median.PMedian at 0x16434fe90&gt;
</pre></div></div>
</div>
<p>How many facilities are allocated? And how many clients will they serve?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for fac, cli in enumerate(pmedian_capacity_from_cm.fac2cli):
    if len(cli) &gt; 0:
        print(f&quot;facility {fac} serving {len(cli)} clients&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
facility 1 serving 16 clients
facility 2 serving 11 clients
facility 3 serving 14 clients
facility 4 serving 10 clients
facility 5 serving 10 clients
facility 6 serving 14 clients
facility 7 serving 14 clients
facility 8 serving 11 clients
</pre></div></div>
</div>
<section id="Capacitated-p-median-problem-with-preselected-facilities">
<h3>Capacitated p-median problem with preselected facilities<a class="headerlink" href="#Capacitated-p-median-problem-with-preselected-facilities" title="Link to this heading">¶</a></h3>
<p>In many real world applications there may already be existing facility locations with the goal being to add one or more new facilities. Here we will define facilites <span class="math notranslate nohighlight">\(y_0\)</span> and <span class="math notranslate nohighlight">\(y_1\)</span> as already existing (they must be present in the model solution). This will lead to a sub-optimal solution.</p>
<p>In the context of the capacitated p-median problem in <code class="docutils literal notranslate"><span class="pre">spopt</span></code>, it’s also possible to consider facilities that have already been chosen beforehand.</p>
<p><strong>Important:</strong> When using the <code class="docutils literal notranslate"><span class="pre">from_cost_matrix</span></code> method to solve capacitated p-median problem with preselected facilities, it is necessary for the user to supply a NumPy array as the <code class="docutils literal notranslate"><span class="pre">predefined_facilities_arr</span></code> parameter. This parameter represents the array of predefined facilities that are required to be included in the solution.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>predefine = numpy.array([0,1])
pmedian_capacity_predefined_from_cm = PMedian.from_cost_matrix(
    cost_matrix,
    ai,
    p_facilities=8,
    facility_capacities=cj,
    predefined_facilities_arr=predefine,
    name=&quot;p-median-predefined-facilities-network-distance&quot;
)
pmedian_capacity_predefined_from_cm = pmedian_capacity_predefined_from_cm.solve(solver)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for fac, cli in enumerate(pmedian_capacity_predefined_from_cm.fac2cli):
    if len(cli) &gt; 0:
        print(f&quot;facility {fac} serving {len(cli)} clients&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
facility 0 serving 14 clients
facility 1 serving 12 clients
facility 2 serving 11 clients
facility 3 serving 14 clients
facility 4 serving 10 clients
facility 5 serving 11 clients
facility 6 serving 14 clients
facility 7 serving 14 clients
</pre></div></div>
</div>
<p>From the result, in total 8 facilities are allocated, and <span class="math notranslate nohighlight">\(y_0\)</span> and <span class="math notranslate nohighlight">\(y_1\)</span> are two of them.</p>
<p>One more new function about preselected facilities, is that you can choose whether to fulfill its capacity. For example, the capacity of <span class="math notranslate nohighlight">\(y_0\)</span> is 97, and you wish to assign 97 demand value to it. It sometimes happens when you need to meet specific facility requirements.</p>
<p>The function name is <code class="docutils literal notranslate"><span class="pre">fulfill_predefined_fac</span></code>. Here is the example of how to use it.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pmedian_capacity_fulfill_predefined_from_cm = PMedian.from_cost_matrix(
    cost_matrix,
    ai,
    p_facilities=8,
    facility_capacities=cj,
    predefined_facilities_arr=predefine,
    fulfill_predefined_fac=True,
    name=&quot;p-median-fulfill-predefined-facilities-network-distance&quot;
)
pmedian_capacity_fulfill_predefined_from_cm = pmedian_capacity_fulfill_predefined_from_cm.solve(solver)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for fac, cli in enumerate(pmedian_capacity_fulfill_predefined_from_cm.fac2cli):
    if len(cli) &gt; 0:
        print(f&quot;facility {fac} serving {len(cli)} clients&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
facility 0 serving 15 clients
facility 1 serving 19 clients
facility 2 serving 10 clients
facility 3 serving 10 clients
facility 5 serving 13 clients
facility 6 serving 12 clients
facility 7 serving 9 clients
facility 9 serving 12 clients
</pre></div></div>
</div>
<p>From the result, we can see that the number of clients they will serve is different. Because we set the constraint to fulfill the capacity of preselected facilities, we get the different solutions.</p>
</section>
</section>
<section id="References">
<h2>References<a class="headerlink" href="#References" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://doi:10.1287/opre.13.3.462">Hakimi, S. L. (1965). Optimum Distribution of Switching Centers in a Communication Network and Some Related Graph Theoretic Problems. Operations Research, 13(3), 462–475.</a></p></li>
<li><p><a class="reference external" href="http://ndl.ethernet.edu.et/bitstream/123456789/22145/1/45.pdf">Church, R. L., &amp; Murray, A. T. (2009). Business site selection, location analysis, and GIS (pp. 209-233). Hoboken, NJ: John Wiley &amp; Sons.</a></p></li>
<li><p><a class="reference external" href="https://www.springer.com/gb/book/9783319998459">Church, R. L., &amp; Murray, A. T. (2018). Location covering models: History, applications and advancements (1st edition 2018). Springer</a></p></li>
</ul>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../_sources/notebooks/p-median.ipynb.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2020-, pysal developers.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.3.7.<br/>
    </p>
  </div>
</footer>
  </body>
</html>